import { handleResizeOrRotate } from './main.js';


export const files = {

    vivian:{
        musid:'Gold',
        title: "Our Golden Age",
        pages:[
            `<b>(Torn pages from a children's school book)</b> <br><br>` +
            `Once, the world was a puzzle of broken pieces.<br><br>` +
            `Kingdom fought kingdom.<br>` +
            `City fought city.<br>` +
            `Neighbor fought neighbor.<br><br>` +
            `Flags flew from every roof, yet no one felt at home.<br>` +
            `Champions stood on every corner, yet no one came to save us.<br><br>` +
            `Streets were paved with "victory," yet the people were lost.<br>` +
            `Children learned the rhythm of drums before the songs of joy.<br><br>` +
            `Every land claimed they were right.<br>` +
            `Every ruler claimed they were chosen.<br>` +
            `Every army promised the next battle would be the last.<br><br>` +
            `<b>But the sun always rose on a world still at war...</b><br>`,

            `Then came <b>Arno von Vivian.</b><br><br>` +
            `Arno did not offer the fire of revenge.<br>` +
            `He did not seek the crown of a conqueror.<br>` +
            `He brought a gift that the old kings had long forgotten:<br><br>` +
            `<b>“PEACE.”</b><br><br>` +
            `The greedy laughed. The cruel resisted.<br>` +
            `The weary doubted, but the children hoped.<br><br>` +
            `<b>Arno did not falter.</b><br><br>` +
            `His left hand was firm upon his sword to protect the weak,<br>` +
            `but his right hand was <b>open to welcome the world.</b><br><br>` +
            `Arno marched across the map of Allarssyn.<br>` +
            `Wherever he walked, <b>the thunder of war fell silent.</b><br>`,
    

            `Old borders washed away like ink in the rain.<br>` +
            `Armies lowered their spears and raised their sights.<br>` +
            `Men learned to speak before they learned to strike.<br><br>` +
            `<b>Allarssyn</b> finally became one heart, beating together.<br>` +
            `When the last wall crumbled, the wars were over.<br>` +
            `Not resting. Not waiting. <br><br>` +
            `<b>FINISHED.</b><br><br>` +
            `Arno declared us <b>United.</b><br>` +

            `No <b>soul</b> above others.<br>`+
            `No <b>blood</b> is superior to another.<br><br>`+
            `<b>For the first time, the world slept without a sword beneath its pillow.</b><br>`,

            `With the fighting gone, the world began to bloom.<br>` +
            `We built roads to find each other, not walls to hide.<br>` +
            `Knowledge flowed like water, and every cup was full.<br>` +
            `Children grew tall without ever learning the weight of a shield.<br><br>` +
            `<b>Peace became our heartbeat.</b><br>` +
            `Arno von Vivian gave us more than just peace;<br>` +
            `He gave us a future. <b>OUR GOLDEN AGE.</b><br>`+
            `<br><b><i>END OF LESSON</i></b><br>`
            ]
        },


 beast:{
        title: "THE BEAST - 1",
        musid:'WHERE',
        pages:[
            `<b>Louis Willis — Classified Personal Record</b><br><br>

            I am… I remain. I collect the shards of my name like broken glass. <br>
            Louis Willis. Louis Willis. Louis Willis. If I say it, perhaps I'll wake up from this weird dream.<br><br>

            One moment there was ground and sound and weight, <br> and then there was <i>everything at once</i>.<br><br>
    
            I felt my world dissolve. Not like salt in water, but like a <i>thought forgotten.</i><br><br>
    
            There was pressure without force.<br>
            Motion without direction.<br>
            I was stretched across moments I never lived.<br>
            Remembering memories that were not mine.<br><br>
    
            <b>The Black Pyramid</b>. Shattered.<br>
            Weeping into an infinite sea.<br><br>

            I am afraid. Afraid that if I to stop writing.<br>
            I am afraid that when I do, whatever is holding me together<br> will realize I should have been dead.`
    ]
    },


    
    beast1:{
        title: "THE BEAST - 2",
        musid:'WHERE',
        pages:[
            `<b>Louis Willis — Classified Personal Record</b><br><br>


            I awoke upon stone that was too perfect in its imperfection. Every crack, every pockmark of erosion feels… deliberate.<br><br>


            My body look... feels different.<br>
            I have marks around my right eye. Like burned veins.<br><br>


            I turned my gaze to the sky, bracing for the heat to peel my skin or the radiation to blind me.<br>
            <b>Nothing.</b><br><br>
            The air entered my lungs. My throat didn't close.<br><br>


            I have seen this before. In dreams. Could it be?<br>
            <b>My paradise.</b><br><br>


            I can't feel time passing. There is no difference Between where I was and where I am, it feels like it's all happening at once.<br><br>


            This is not my world.<br>
            <b>Where am I?</b><br>`
    ]
    },



    beast2:{
        title: "THE BEAST - 3",
        id:"file97",
        musid:'',
        pages:[
            '<b>AUTHOR:</b> Louis Wills. Chief scientist<br>' +
            '<b>SUBJECT:</b> The Structure of Existence<br><br>' +

            'For the sake of clarity, I will refer to it as <b>“The Beast.”</b><br>' +

            'The Beast is not a creature in the conventional sense.<br>' +
            'It does not hunt. It does not judge.<br>' +
            'But It does seem aware of us as individuals. That is… something.<br><br>' +

            'The Beast is better understood as a living architecture of thought, memory, and possibility.<br>' +
            'A universe that behaves less like a machine…<br>' +
            'And more like a <b>mind</b>.<br><br>' +


            'Every world, every reality, every life exists as just a <b><i>thought.</i></b><br>' +
            'One that can be forgotten.<br><br>'+

            `I keep returning to the same pattern, no matter how I approach it.<br>
            Three layers. Not places. Not exactly.`,



            '<b>THREE STRATA OF EXISTENCE</b><br><br>' +

            'I have identified three distinct layers within the Beast. For ease of communication, I have borrowed psychological terminology.<br><br>' +

            '<b>1. THE ULTRA EGO</b><br>' +
            'These are the <b>Worlds of Rule</b>.<br>' +
            'Places governed by consistency: gravity, causality, time, logic.<br>' +

            '<b>Allarssyn</b> is an Ultra Ego world.<br>' +
            'So was my <b>world</b>...<br><br>' +


            '<b>Ultra Ego worlds</b> are stable only as long as they are <b>remembered</b> by the Beast.',



            '<b>2. THE EGO (The In-Between)</b><br>' +
            'The Ego is not a place so much as a <b>transition</b>.<br>' +
            'It is mutable, symbolic, and deeply irrational.<br><br>' +

            'This is where myths breathe.<br>' +
            'Where dragons make sense.<br>' +
            'Where impossible geography feels natural.<br><br>' +

            'The Ego functions as a mediator, or a hub between all kind worlds.<br>' +
            'It is accessed primarily through <b>dreams</b>.<br><br>' +

            'When a person dreams, their consciousness briefly disconnects from the Ultra Ego and drifts into the Ego.<br>' +
            'This connection is not optional.<br>' +
            '<b>A world that cannot dream is a world that cannot persist.</b>'
            ,

            '<b>THE BLACK PYRAMID</b><br><br>' +

            'My current theory of what The Black Pyramid. Is a central construct within the Ego.<br>' +
            'I believe to have functioned as a <b>Unified Ego</b>.<br>' +
            'A time where <b>ALL</b> things were one.<br><br>' +

            `Which explained why it's shattered,<br>` +
            'which would explain our world and worlds like ours.<br><br>' +

            'Each Ultra Ego world may be nothing more than a host for the <b>Shards</b>,<br>' +
            'which form a self-contained bubble of reality, floating just far enough apart to avoid collapse.',

            '<b>3. THE ID (The Void / The Unknown)</b><br>' +

            'Contact with the Id results in cognitive dissolution, loss of identity, or worse outcomes I am unwilling to document further...<br><br>' +

            `Studies of, or contact with, anything regarding the Id is <b>prohibited.</b><br>` +
            'For the sake of all things, <b>LEAVE IT BE.</b><br>' +
            'As it leaves us be.'+

            '<b>FINAL NOTE</b><br><br>' +

            'Once a world loses the ability to dream,<br>' +
            'To remind <b>The Ego</b> of their existence.,<br>' +
            'The world simply dissolve to <b>The void</b>,<br>' +
            'there is no known method of retrieval.<br><br>' +

            'We do not live <i>in</i> the beast<br>' +
            '<b>We live inside its attention.</b>'
        ]
    },

    
falco:{
    musid:'falco-theme',
    title:"AUDIO LOG",
    pages:[
        `
        <b>VIVI AUDIO LOG 47</b><br><br>
        <b>VIVI:</b> "Let me go, you psycho!"<br><br>

        <b>FALCO:</b> "Father! It’s me. Look at me! I know you are in there. Just talk to me!"<br><br>

        <b>VIVI:</b> "I don't know you! You creep, leave me alone!"<br><br>

        <b>VIVI:</b> "Quinnnnnn? Quinn, I think I’m being kidnapped by a fanboy!"<br><br>

        <b>FALCO:</b> "SHUT UP! ... I—sorry. Sorry, Father. Please, just lower your voice. I can restore you, I'll find a way."<br><br>

        <b>FALCO:</b> "I have Louis's research, I'll start from there. Just please help me out over here!"`,

        `<b>VIVI:</b> "You have serious issues, kid. You can’t just kidnap people and expect them to play 'Father and Son' with you. It’s weird. It’s really awkward."<br><br>

        <b>VIVI:</b> "QUINNNNNNNNNN!"<br><br>

        <b>FALCO:</b> "Please SHUT— ... Father, please..."<br><br>

        <b>FALCO:</b> "Why do you love her this much? Huh? After she left you? After she called you a monster?"<br><br>

        <b>FALCO:</b> "I’m your blood. I’m your son... but it’s always her. It’s always been her."<br><br>

        <b>FALCO:</b> "You don't even look me in the eyes... you were just scanning the room for a ghost to come home."`,

        `<b>VIVI:</b> "Ummmmmm... look, I'm sorry for what you are going through, kid. It's really crappy."<br><br>

        <b>FALCO:</b> "Did you even love me?"<br><br>

        <b>VIVI:</b> "Oh please someone help me... I can't handle this THE AWKWARDNESS."<br><br>

        <b>VIVI:</b> "/QUINNNNNNNNNNNNNN/."<br><br>

        <b>FALCO:</b> [Sobbing] "Don't worry, Father."<br><br>

        <b>FALCO:</b> "I’ll find a way. I’ll save you. I’ll save the world."<br><br>

        <b>FALCO:</b> "I’ll make you proud. I’ll make you look at me the way you looked at her."`,

        `<b>VIVI:</b> "Please... sure, buddy! You do that. Go save the world. Just do it somewhere else."<br><br>

        <b>VIVI:</b> "And LEAVE ME BE!"<br><br>

        <b>VIVI:</b> "QUINNNNNN! THERE YOU ARE!"<br><br>

        <b>FALCO:</b> "...Quinn."<br><br>

        <b>QUINN:</b> "Give him back, Falco."<br><br>

        <b>FALCO:</b> "What are you planning to do? I’ve spent my whole life training to be the son he wanted. I overpower you in every way."<br><br>

        <b>QUINN:</b> "Sorry, Falco."<br><br>

        [EMP GRENADE DETONATION]<br>
        [AUDIO ENDS IN STATIC]`
    ]
},


projectv:{
    title:"[FILE 7]",
    id:"file99",
    musid:'',
    pages:[
        '<b>SUBJECT:</b> PROJECT VIVIAN<br>' +
        '<b>AUTHOR:</b> Louis Wills, Chief Scientist<br><br>' +

        '<b>OVERVIEW:</b> Project Vivian was initiated as a long-term contingency program.<br>' +
        'Its purpose is <b>continuity</b>.<br>' +
        'In the event that Emperor Arno von Vivian succumbed to his illness, his body may fail, but his existence would not.<br><br>' +

        '<b>THE MATERIAL:</b> The defining breakthrough of Project VIVIAN was not the Pod itself, but the discovery of its construction medium.<br>' +
        'The material was first observed forming naturally in regions surrounding the <b>World Shard</b>. '+
        'Outside the Shard’s influence, the material exhibits absolute structural stability.<br>' +
        'It cannot be cut, fractured, melted, or altered through any known mechanical or energetic process.' ,

        'Proximity to the Shard produces the inverse effect.<br>' +
        'As distance decreases, the material progressively loses rigidity.<br>' +
        'Within close range, it becomes pliable, moldable, and responsive to applied force, comparable to soft composite clay.<br><br>' +

        'This state is temporary.<br>' +
        'Once removed from the Shard’s influence, the material irreversibly returns to its inert, stable form.<br>' +
        'All structural decisions become permanent at that moment.<br><br>' +

        '<b>THE POD:</b> Each VIVI Pod is a sealed cognitive environment.<br>' +
        'It is designed to host a living brain while replicating the sensory and regulatory feedback normally provided by a biological body.<br><br>' +

        '<b>THE BACKUP PERSONALITY:</b> A secondary cognitive framework is embedded within the Pod.<br>' +
        'This framework functions as a fallback system in the event of host failure, instability, or loss of executive control.<br><br>' +
        'When activated, <b>VIVI</b> assumes operational autonomy and guides the Pod toward the nearest viable point of safety or recovery.<br><br>',

        '<b>AUGMENTATION:</b> The Pod can be equipped with autonomous defense and mobility systems.<br>' +
        'These include electromagnetic discharge capabilities and short-range propulsion.<br><br>' +
        'Such features is still in development and will be added to ensure a long-term independence from external protection.<br><br>'
    ]
},


quinn:{
    musid:'arno',
    title:"Opened Letter",
    pages:[
        `<b>To Quinn,</b><br><br>

        I do not know if you will read this...<br>
        I only know that you will find it.<br><br>

        I have written many speeches in my life.<br>
        Declarations. Lessons meant for entire nations.<br>
        <b>None of them were as difficult as this.</b><br><br>

        I remember the first time I saw you.<br>
        You do not remember it the same way.<br> You were too young. Too busy surviving.<br>
        You were watching hands, not faces. Watching exits. Measuring distance.<br>
        You had already learned the habits of a hunted thing.<br>
        That day frightened me, it was like looking in the mirror.<br>
        <b>The world had already failed you, like it failed me...</b><br><br>`,

        `I made choices...<br>
        Terrible ones. <b>Very Terrible ones</b>.<br>
        Choices that history will forgive, because history is written by the victors.<br>
        But forgiveness from the world has never mattered to me. <br><b>Only yours.</b><br><br>

        Everything I build, every action I take, every thought I think,<br> was for one simple dream:<br>
        <b>That dream is you not having to do what I had done and still do.</b><br><br>

        A place where you would not have to kill.<br>
        Where you would not have to run.<br>
        Where you would not have to die.<br><br>`,


        `<b>I never meant to become anything to you.</b><br>
        I was supposed to kill you that day.<br>
        But it's like you had this light, that was about to extinguish.<br>
        I didn't want it to fade. So I stayed. <br>
        I watched you learn how to trust. <br>
        I watched you learn how to survive without running.<br>
        Somewhere along the way, I stopped seeing a contract.<br> And started seeing someone I couldn’t leave behind.<br><br>

        I never said it. I never claimed it.<br>
        I told myself I had no right.<br><br>
        But I want you to know, in my heart, <br><b>I have always felt like father to you.</b><br><br>
        <b>That never and will never change.</b><br>
        Even when you look at me like a stranger.<br> 
        Even when you try to kill me.<br>`,

        `If this letter has reached you, then I am still here.<br>
        Waiting for you.<br>
        Not as an emperor.<br>

        <b>Just some old man who wants one last chance to speak to his child.</b><br><br>

        <b>Please, Quinn.</b><br>

        Come see me. I don't think I have long.<br><br>

        Your old man.
        — <b>Arno von Vivian</b>`
    ]
},

}


document.getElementById('file0').onclick = () => {addItemToBackpack(files.vivian,'file0');};
document.getElementById('file1').onclick = () => {addItemToBackpack(files.beast,'file1');};
document.getElementById('file2').onclick = () => {addItemToBackpack(files.falco,'file2');};
document.getElementById('file3').onclick = () => {addItemToBackpack(files.beast1,'file3');};
//document.getElementById('file4').onclick = () => {addItemToBackpack(files.beast2,'file4');};

const titleEl = document.getElementById('view-title');
const bodyEl = document.getElementById('view-body');
const pageEl = document.getElementById('page-num');


export let smootherInstance = null; 
const VIVICHARA = document.getElementById('secret-vivi');


export function setSmootherInstance(instance) {
    smootherInstance = instance;
}

let scrollPosition = 0;

export function lockScroll() {
  scrollPosition = window.pageYOffset;
  document.body.style.overflow = 'hidden';
  document.body.style.position = 'fixed';
  document.body.style.top = `-${scrollPosition}px`;
  document.body.style.width = '100%';
}

export function unlockScroll() {
  document.body.style.overflow = 'visible';
  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.width = '';
  window.scrollTo(0, scrollPosition);
}

export function hideLoader() {
    const loader = document.getElementById('loader-wrapper');
    if (loader) {
        gsap.to(loader, { 
            opacity: 0, 
            duration: 0.5, 
            ease: "power2.inOut",
            onComplete: () => {
                loader.style.visibility = 'hidden';
                loader.style.pointerEvents = 'none';
                unlockScroll();
            }
        });
    } else {unlockScroll();
    }


}


export function showStartButton() {
    const tl = gsap.timeline();

    tl
    .to("#loading-bar",{ backgroundColor:"#00ffff", repeat: -1, yoyo: true, duration: 1 })
    .to("#start-btn", { visibility: 'visible', opacity: 1, duration: 2,},"<")
    .to("#loading-text",{text:"Ready when you are." , duration: 2},"<")
    .to("#loading-title",{text:"./PROJECT VIVIAN" , duration: 2},"<")
}


export function killGSAP() {
    ScrollTrigger.killAll();
    gsap.set([".parallax-layer",".seven"], { clearProps: "all" });
    if (smootherInstance) {
        smootherInstance.kill();
        smootherInstance = null;
    }
    ScrollTrigger.refresh();
}


// --- FULLSCREEN LOGIC ---
const fullscreenToggle = document.getElementById('fullscreenToggle');
if (fullscreenToggle) {fullscreenToggle.addEventListener('click', () => fullscreen());}
window.addEventListener('fullscreenchange', () => updateButtonText(fullscreenToggle));

export function fullscreen(){
    if (!document.fullscreenElement) {
        handleResizeOrRotate();
        document.documentElement.requestFullscreen();
    } else {
        handleResizeOrRotate();
        document.exitFullscreen();
    }
    updateButtonText(fullscreenToggle);
}

function updateButtonText(fullscreenToggle) {
    if (document.fullscreenElement) {
        fullscreenToggle.textContent = "Exit Fullscreen (F11)";
    } else {
        fullscreenToggle.textContent = "Go Fullscreen (F11)";
    }
}



const footstepSounds = ['f0', 'f1', 'f2', 'f3'];

export function playRandomStep() {
    const randomId = footstepSounds[Math.floor(Math.random() * footstepSounds.length)];
    const sound = document.getElementById(randomId);
    
    if (sound) {
        sound.currentTime = 0;
        sound.volume = 1.0;
        sound.play();
    }
}

const neonImg = document.querySelector('.project-vivian');
const neonImg2 = document.querySelector('.project-vivian2');
const volumeSlider = document.getElementById('volume-slider');
const cornerSlider = document.querySelector('#corner-volume-slider');

// 1. Setup the ONE and ONLY Audio Context
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const masterBus = audioCtx.createGain();
masterBus.connect(audioCtx.destination);

// Set initial volume (from session storage or default to 0.5)
const savedVolume = sessionStorage.getItem('userVolume') || 0.0;
masterBus.gain.value = savedVolume;
volumeSlider.value = savedVolume;
cornerSlider.value = savedVolume;
neonImg.style.setProperty('--intensity', savedVolume);
neonImg2.style.setProperty('--intensity', savedVolume);

// 2. Connect all audio tags (Only do this once!)
const audioElements = Array.from(document.querySelectorAll('audio'));
audioElements.forEach(el => {
    const source = audioCtx.createMediaElementSource(el);
    source.connect(masterBus);
});

// 3. Start Button Logic
const startBtn = document.getElementById('start-btn');
startBtn.addEventListener('click', async () => {
    hideLoader();
    
    // IMPORTANT: Resume the existing context
    if (audioCtx.state === "suspended") {
        await audioCtx.resume();
    }

    // Play your specific background tracks
    const toPlay = ["s0-bg", "s1-bg", "s2-bg", "trem", "ele"];
    toPlay.forEach(id => {
        const el = document.getElementById(id);
        el.play().catch(e => console.log("Playback blocked for:", id));
    });
});


// 4. Volume Slider Logic
function updateVolume(value) {
    // 1. Update the Audio Context
    masterBus.gain.value = value;
    
    // 2. Sync both slider UI positions
    volumeSlider.value = value;
    cornerSlider.value = value;
    
    // 3. Optional: Update your Neon Intensity variable from earlier
    if(neonImg) neonImg.style.setProperty('--intensity', value);
    if(neonImg2) neonImg2.style.setProperty('--intensity', value);
    if(VIVICHARA) VIVICHARA.style.filter = `brightness(${value})`;

    // 4. Save to session
    sessionStorage.setItem('userVolume', value);
}

// Listener for Dashboard Slider
volumeSlider.addEventListener('input', (e) => updateVolume(e.target.value));

// Listener for Corner Slider
cornerSlider.addEventListener('input', (e) => updateVolume(e.target.value));
// 5. Slider Feedback Sound


const feedbackSound = document.getElementById('vslider');
volumeSlider.addEventListener('mousedown', () => feedbackSound.play());
cornerSlider.addEventListener('mousedown', () => feedbackSound.play());
window.addEventListener('mouseup', () => feedbackSound.pause());







const allButtons = document.querySelectorAll('button');
const pressSFX = document.getElementById('press');
const pturn = document.getElementById('pturn');
allButtons.forEach(btn => {
    btn.addEventListener('mousedown', () => {
        if (!btn.classList.contains('ctrl-btn') && !btn.classList.contains('inv-tool-icon')) {pressSFX.play();}
    });
});


const desktopRatioQuery = "(min-aspect-ratio: 4/3)";
if (!window.matchMedia(desktopRatioQuery).matches) {updateVolume(1.0);}








const invIcon = document.querySelector('.inv-tool-icon');
const invWrapper = document.querySelector('.inv-wrapper');

// Create an overlay div in JS if it doesn't exist
const overlay = document.createElement('div');
overlay.id = 'inv-overlay';
document.body.appendChild(overlay);

// OPEN FUNCTION
function openInventory() {
    document.getElementById('bopen').play();
    lockScroll();
    invIcon.classList.add('unclickable');
    invIcon.classList.add('is-active');

    const tl = gsap.timeline();

    tl.to(invIcon, {
        left: "15vw",
        bottom: "-5vh",
        scale: 5.2,
        duration: 0.5,
        ease: "back.in(1.7)",
    })
    .to(invIcon, {
        opacity: 0,
        duration: 0.3
    }, "+=0.1")
    .to([invWrapper, overlay], {
        autoAlpha: 1, // Sets visibility: visible and opacity: 1
        duration: 0.5
    }, "-=0.1");
}

// CLOSE FUNCTION
function closeInventory() {
    titleEl.innerHTML = 'NO ENTRY SELECTED';
    bodyEl.innerHTML = 'Select an entry from the backpack. <br> <i>If you have one</i>';
    pageEl.innerHTML = 1;

    inventoryData.forEach(item => {if(item.musid != '')fadeOut(document.getElementById(item.musid), 1000);});
    document.getElementById('bclose').play();
    unlockScroll();
    const tl = gsap.timeline();

    tl.to([invWrapper, overlay], {
        autoAlpha: 0,
        duration: 0.3
    })
    .to(invIcon, {
        opacity: 1,
        scale: 1,
        left: "3vw",
        bottom: "1vw",
        duration: 0.5,
        onComplete: () => {
            invIcon.classList.remove('unclickable');
            invIcon.classList.remove('is-active');        
        }
    },"<");
}

// Event Listeners
invIcon.addEventListener('click', openInventory);
overlay.addEventListener('click', closeInventory); // Close when clicking outside






let currentItem = null;
let inventoryData = JSON.parse(sessionStorage.getItem('inv')) || [
    {
        title: files.quinn.title,
        pages: files.quinn.pages,
        id: files.quinn.id,
        musid: files.quinn.musid,
        currentPage: 0
    }
];
updateInv();

export function addItemToBackpack(fileObj, elementId) {
    if (elementId) {
        const el = document.getElementById(elementId);
        if (el) el.style.display = 'none';
    }

    // Create the new item
    const newItem = { 
        title: fileObj.title, 
        pages: fileObj.pages,
        id: elementId,
        musid: fileObj.musid,
        currentPage: 0 
    };

    inventoryData.push(newItem);
    
    sessionStorage.setItem('inv', JSON.stringify(inventoryData));
    
    triggerNotification('Collected ' + newItem.title);
    document.getElementById('file').play();
    updateInv();
}

function updateInv() {
    titleEl.innerHTML = 'NO ENTRY SELECTED';
    bodyEl.innerHTML = 'Select an entry from the backpack. <br> <i>If you have one</i>';
    pageEl.innerHTML = 1;

    const listContainer = document.getElementById('inv-list-container');
    
    listContainer.innerHTML = ''; 

    inventoryData.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'inv-list-item';
        div.innerHTML = `> ${item.title}`;
        div.onclick = () =>{
            displayItem(item);
            if (item.musid !='')playMusic(document.getElementById(item.musid), 1200);
            else inventoryData.forEach((item) => {fadeOut(document.getElementById(item.musid), 1000)})

        }



        listContainer.appendChild(div);
        const itemElement = document.getElementById(item.id);
        if (itemElement)itemElement.style.display = 'none';
    });
}

function displayItem(item) {
    pturn.currentTime = 0;
    pturn.play();
    currentItem = item;

    titleEl.innerHTML = item.title;
    bodyEl.innerHTML = item.pages[item.currentPage];
    pageEl.innerHTML = `${item.currentPage + 1} / ${item.pages.length}`;
}

// Next/Prev Page Logic
document.getElementById('next-btn').onclick = () => {
    pturn.currentTime = 0;
    pturn.play();
    if (currentItem && currentItem.currentPage < currentItem.pages.length - 1) {
        currentItem.currentPage++;
        displayItem(currentItem);
    }
};

document.getElementById('prev-btn').onclick = () => {
    pturn.currentTime = 0;
    pturn.play();
    if (currentItem && currentItem.currentPage > 0) {
        currentItem.currentPage--;
        displayItem(currentItem);
    }
};




const slider = document.getElementById('inv-list-container');
let isDown = false;
let startY;
let scrollTop;

slider.addEventListener('mousedown', (e) => {
    isDown = true;
    slider.classList.add('active-grab'); // Optional: change cursor to 'grabbing'
    startY = e.pageY - slider.offsetTop;
    scrollTop = slider.scrollTop;
});

slider.addEventListener('mouseleave', () => {isDown = false;});
slider.addEventListener('mouseup', () => {isDown = false;});

slider.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const y = e.pageY - slider.offsetTop;
    const walk = (y - startY) * 1.5; // The '2' is scroll speed multiplier
    slider.scrollTop = scrollTop - walk;
});




function triggerNotification(text) {
    const noti = document.querySelector('.noti');
    const notiText = noti.querySelector('p');
    notiText.innerHTML = text;
    
    noti.classList.add('active');
    
    setTimeout(() => {
        noti.classList.remove('active');
    }, 3000);
}







let currentAudio = null;

function playMusic(audio, fadeDuration = 1000) {
    if (!audio) return;

    // If same track, do nothing
    if (currentAudio === audio) return;

    // Fade out old track
    if (currentAudio) {
        fadeOut(currentAudio, fadeDuration);
    }

    // Fade in new track
    fadeIn(audio, fadeDuration);
    currentAudio = audio;
}




function killFade(audio) {
    if (audio._fadeInterval) {
        clearInterval(audio._fadeInterval);
        audio._fadeInterval = null;
    }
}

function fadeOut(audio, duration = 1000) {
    if (!audio) return;

    killFade(audio);

    const step = audio.volume / (duration / 50);

    audio._fadeInterval = setInterval(() => {
        if (audio.volume > step) {
            audio.volume -= step;
        } else {
            audio.volume = 0;
            audio.pause();
            killFade(audio);
        }
    }, 50);
}

function fadeIn(audio, duration = 1000) {
    if (!audio) return;

    killFade(audio);

    audio.volume = Math.max(audio.volume, 0);
    audio.play();

    const step = 1 / (duration / 50);

    audio._fadeInterval = setInterval(() => {
        if (audio.volume < 1 - step) {
            audio.volume += step;
        } else {
            audio.volume = 1;
            killFade(audio);
        }
    }, 50);
}
